name: Run Tests and Generate Report

on:
  workflow_call:
    inputs:
      dotnet-version:
        description: '.NET SDK version to use'
        required: false
        type: string
        default: '8.0.x'
      configuration:
        description: 'Build configuration (Debug/Release)'
        required: false
        type: string
        default: 'Release'
      environment:
        description: 'Target environment (Development/Production)'
        required: false
        type: string
        default: 'Development'
      test-filter:
        description: 'Test category filter (all/smoke/regression)'
        required: false
        type: string
        default: 'all'
      run-tests:
        description: 'Whether to run tests'
        required: false
        type: boolean
        default: true
      generate-report:
        description: 'Whether to generate Allure report'
        required: false
        type: boolean
        default: true
    outputs:
      test-result:
        description: 'Test execution result'
        value: ${{ jobs.test.outputs.result }}
      total-tests:
        description: 'Total number of tests'
        value: ${{ jobs.test.outputs.total }}
      passed-tests:
        description: 'Number of passed tests'
        value: ${{ jobs.test.outputs.passed }}
      failed-tests:
        description: 'Number of failed tests'
        value: ${{ jobs.test.outputs.failed }}

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    outputs:
      result: ${{ steps.test-run.outcome }}
      total: ${{ steps.test-count.outputs.total }}
      passed: ${{ steps.test-count.outputs.passed }}
      failed: ${{ steps.test-count.outputs.failed }}

    permissions:
      contents: read
      checks: write
      pull-requests: write

    env:
      TEST_ENVIRONMENT: ${{ inputs.environment }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ inputs.dotnet-version }}

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Restore dependencies
      run: dotnet restore src/BookstoreApiTests.Tests/BookstoreApiTests.Tests.csproj

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-output
        path: src/BookstoreApiTests.Tests/bin/${{ inputs.configuration }}/net8.0
      continue-on-error: true

    - name: Build (if no artifacts)
      run: |
        if [ ! -f "src/BookstoreApiTests.Tests/bin/${{ inputs.configuration }}/net8.0/BookstoreApiTests.Tests.dll" ]; then
          echo "No build artifacts found, building..."
          dotnet build src/BookstoreApiTests.Tests/BookstoreApiTests.Tests.csproj --no-restore --configuration ${{ inputs.configuration }}
        else
          echo "Using downloaded build artifacts"
        fi

    - name: Determine test filter
      id: filter
      run: |
        if [ "${{ inputs.test-filter }}" == "smoke" ]; then
          echo "filter=Category=Smoke" >> $GITHUB_OUTPUT
        elif [ "${{ inputs.test-filter }}" == "regression" ]; then
          echo "filter=Category=Regression" >> $GITHUB_OUTPUT
        else
          echo "filter=" >> $GITHUB_OUTPUT
        fi

    - name: Run tests
      id: test-run
      if: ${{ inputs.run-tests }}
      run: |
        FILTER="${{ steps.filter.outputs.filter }}"
        if [ -n "$FILTER" ]; then
          dotnet test src/BookstoreApiTests.Tests/BookstoreApiTests.Tests.csproj \
            --no-build \
            --configuration ${{ inputs.configuration }} \
            --filter "$FILTER" \
            --logger "trx;LogFileName=test-results.trx" \
            --logger "console;verbosity=detailed" \
            --results-directory ./TestResults
        else
          dotnet test src/BookstoreApiTests.Tests/BookstoreApiTests.Tests.csproj \
            --no-build \
            --configuration ${{ inputs.configuration }} \
            --logger "trx;LogFileName=test-results.trx" \
            --logger "console;verbosity=detailed" \
            --results-directory ./TestResults
        fi
      continue-on-error: true

    - name: Count tests
      id: test-count
      if: always()
      run: |
        if [ -f "./TestResults/test-results.trx" ]; then
          TOTAL=$(grep -o 'total="[0-9]*"' ./TestResults/test-results.trx | head -1 | grep -o '[0-9]*' || echo "0")
          PASSED=$(grep -o 'passed="[0-9]*"' ./TestResults/test-results.trx | head -1 | grep -o '[0-9]*' || echo "0")
          FAILED=$(grep -o 'failed="[0-9]*"' ./TestResults/test-results.trx | head -1 | grep -o '[0-9]*' || echo "0")
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "Total: $TOTAL, Passed: $PASSED, Failed: $FAILED"
        else
          echo "total=0" >> $GITHUB_OUTPUT
          echo "passed=0" >> $GITHUB_OUTPUT
          echo "failed=0" >> $GITHUB_OUTPUT
        fi

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: ./TestResults/*.trx
        retention-days: 30

    - name: Install Allure
      if: ${{ inputs.generate-report }}
      run: |
        curl -o allure-2.24.0.tgz -Ls https://github.com/allure-framework/allure2/releases/download/2.24.0/allure-2.24.0.tgz
        tar -zxvf allure-2.24.0.tgz -C /opt/
        sudo ln -s /opt/allure-2.24.0/bin/allure /usr/bin/allure

    - name: Generate Allure Report
      if: ${{ inputs.generate-report }}
      run: |
        mkdir -p allure-results
        if [ -d "./src/BookstoreApiTests.Tests/bin/${{ inputs.configuration }}/net8.0/allure-results" ]; then
          cp -r ./src/BookstoreApiTests.Tests/bin/${{ inputs.configuration }}/net8.0/allure-results/* ./allure-results/ 2>/dev/null || true
        fi
        allure generate ./allure-results --clean -o allure-report || echo "Allure report generation skipped"
      continue-on-error: true

    - name: Upload Allure Report
      uses: actions/upload-artifact@v4
      if: ${{ inputs.generate-report && always() }}
      with:
        name: allure-report
        path: allure-report
        retention-days: 30

    - name: Publish Test Results
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: Test Results
        path: ./TestResults/*.trx
        reporter: dotnet-trx
        fail-on-error: false

    - name: Test Summary
      if: always()
      run: |
        echo "## Test Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Environment | ${{ inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Configuration | ${{ inputs.configuration }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Test Filter | ${{ inputs.test-filter }} |" >> $GITHUB_STEP_SUMMARY
        echo "| .NET Version | ${{ inputs.dotnet-version }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Test Result | ${{ steps.test-run.outcome }} |" >> $GITHUB_STEP_SUMMARY
        if [ -f "./TestResults/test-results.trx" ]; then
          echo "| Total | ${{ steps.test-count.outputs.total }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Passed | ${{ steps.test-count.outputs.passed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Failed | ${{ steps.test-count.outputs.failed }} |" >> $GITHUB_STEP_SUMMARY
        fi
